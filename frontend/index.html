<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comfica</title>
    
    <script src="https://code.jquery.com/jquery-3.7.0.js" integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>

    <script>

        let idBookToDel = 0;
        
		function getBooks() {
            $.ajax({
                url: 'http://127.0.0.1:8000/api/books',
                type: 'GET',
				dataType: 'json',
                success: function(data) {
                    console.log(data);
					var grid = "";
                    var fav= "";
					for(var i = 0; i < data.length; i++) {
                        if(data[i].fav == 1){
                            fav='./images/c2.png';
                        }
                        else{
                            fav='./images/c.png';
                        }
						grid += `<div class="card" style="box-shadow: 5px 5px gray; border-radius: 30px; width: 252px; height: 200px; margin-left: 15px; margin-right: 15px; margin-bottom: 10px; padding-top: 5px;">
                                    <div id="imgcard" style="border-top-left-radius: 20px; border-top-right-radius: 20px; margin-left: -12px; position: relative; width: 252px; height: 200px; background: url('` + data[i].url_img + `'); background-size: auto 100%; background-repeat: no-repeat; background-origin: content-box; padding-left: 5px; padding-right: 5px; background-position: center;">
                                        <button id="btnFav" idBook="` + data[i].id + `" fav="` + data[i].fav + `" style="position: absolute; bottom: 0; right: 0; border: none; background-color: transparent;" onclick="favBook(this);"><img src="` + fav + `" height="30px" width="30px"></button>
                                    </div>
                                    <div class="card-body" idBook="` + data[i].id + `" style="border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; background-color: white;  border-top-style: solid; width: 252px; margin-left: -12px; margin-top: 5px" data-bs-toggle="modal" data-bs-target="#modalDel" onclick="setBookToDel(this);">
                                        <h5 class="card-title">` + data[i].name + `</h5>
                                        <p class="card-text">` + data[i].description + `</p>
                                    </div>
                                </div>`
					}
                    grid += `<div style="position: absolute; width: 80%; height: 10%; bottom: 0;">
                                <button data-bs-toggle="modal" data-bs-target="#modalAdd" id="btnAdd" style="position: fixed; right: 80px; border: none; background-color: blue; color: white; border-radius: 10px; font-size: 12px; width: 120px; height: 30px; ">Adicionar</button>
                            </div>`				
					document.getElementById("board").innerHTML = grid;

				},
				error: function(err) {
					console.log(err.responseText.message);
				}
			});
        }

        function insertBook() {
            $.ajax({
                url: 'http://127.0.0.1:8000/api/books/new',
                type: 'POST',
                data: { 
                    name: document.getElementById('txtLivro').value,
                    description: document.getElementById('txtDescricao').value,
                    url_img: document.getElementById('txtUrl').value,
                    fav: 0
                },
				dataType: 'json',
                success: function() {
                    location.reload();
				},
				error: function(err) {
					console.log(err.responseText.message);
				}
			});
        }

        function favBook(elem){
            changedFav = '';
            if(elem.getAttribute('fav') == 0){
                changedFav = 1;
            }
            else{
                changedFav = 0;
            }

            $.ajax({
                url: 'http://127.0.0.1:8000/api/book/editfav',
                type: 'POST',
                data: { 
                    id: elem.getAttribute('idBook'),
                    fav: changedFav
                },
				dataType: 'json',
                success: function() {
                    location.reload();
				},
				error: function(err) {
					console.log(err.responseText.message);
				}
			});
        }

        function orderBooksByFav() {
            var btnFav = document.getElementById("btnFav");
            var color = btnFav.style.backgroundColor;
            if(color == "purple"){
                getBooks();
            }
            else{
                $.ajax({
                    url: 'http://127.0.0.1:8000/api/books',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        function compare( a, b ) {
                            if ( a.fav < b.fav ){
                                return 1;
                            }
                            if ( a.fav > b.fav){
                                return -1;
                            }
                            return 0;
                        }
                    
                        data.sort(compare)

                        var grid = "";
                        var fav= "";
                        for(var i = 0; i < data.length; i++) {
                            if(data[i].fav == 1){
                                fav='./images/c2.png';
                            }
                            else{
                                fav='./images/c.png';
                            }
                            grid += `<div class="card" style="box-shadow: 5px 5px gray; border-radius: 30px; width: 252px; height: 200px; margin-left: 15px; margin-right: 15px; margin-bottom: 10px; padding-top: 5px;">
                                        <div id="imgcard" style="border-top-left-radius: 20px; border-top-right-radius: 20px; margin-left: -12px; position: relative; width: 252px; height: 200px; background-image: url('` + data[i].url_img + `'); background-size: auto 100%; background-repeat: no-repeat; background-origin: content-box; padding-left: 5px; padding-right: 5px; background-position: center;">
                                            <button id="btnFav" idBook="` + data[i].id + `" fav="` + data[i].fav + `" style="position: absolute; bottom: 0; right: 0; border: none; background-color: transparent;" onclick="favBook(this);"><img src="` + fav + `" height="30px" width="30px"></button>
                                        </div>
                                        <div class="card-body" idBook="` + data[i].id + `" style="border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; background-color: white;  border-top-style: solid; width: 252px; margin-left: -12px; margin-top: 5px" data-bs-toggle="modal" data-bs-target="#modalDel" onclick="setBookToDel(this);">
                                            <h5 class="card-title">` + data[i].name + `</h5>
                                            <p class="card-text">` + data[i].description + `</p>
                                        </div>
                                    </div>`
                        }
                        grid += `<div style="position: absolute; width: 80%; height: 10%; bottom: 0;">
                                    <button data-bs-toggle="modal" data-bs-target="#modalAdd" id="btnAdd" style="position: fixed; right: 80px; border: none; background-color: blue; color: white; border-radius: 10px; font-size: 12px; width: 120px; height: 30px; ">Adicionar</button>
                                </div>`			
                        document.getElementById("board").innerHTML = grid;
                    },
                    error: function(err) {
                        console.log(err.responseText.message);
                    }
			    });
            }


            
        }

        function delBook(){
            console.log(idBookToDel);

            $.ajax({
                url: 'http://127.0.0.1:8000/api/book/destroy',
                type: 'POST',
                data: { 
                    id: idBookToDel
                },
				dataType: 'json',
                success: function() {
                    location.reload();
				},
				error: function(err) {
					console.log(err.responseText.message);
				}
			});
        }
    
        function setBookToDel(elem){
            idBookToDel = elem.getAttribute("idBook");
        }
    
    </script>
</head>
<body onload='getBooks()'>
    <div style="background-color: darkblue; color: white; text-align: center; font-size: 40px;">
        Bibloteca de livros
    </div>

    <div style="padding-top: 20px; padding-bottom: 80px; padding-right: 50px;">
        <button id='btnFav'; style="float: right;  background-color: darkblue; color: white;  border-radius: 10px; font-size: 12px; width: 120px; height: 30px;" onclick="orderBooksByFav();">Favoritos</button>
    </div>

    <div class="row" id="board" style="padding-top: 30px;
                padding-bottom: 30px;
                padding-right: 30px;
                margin-bottom: 30px;
                margin-left: 30px; 
                margin-right: 30px;
                height: 500px;
                width: 95%;
                border-radius: 20px;
                background-color: rgb(206, 223, 229);
                overflow: auto;
                position: relative;">
    </div>
    
    <div class="modal fade bd-example-modal-xl" id="modalAdd" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
          <div class="modal-content">
            <div class="modal-header" style="background-color: darkblue; color: white; padding: 7px;">
              <h5 class="modal-title" id="exampleModalLabel" style="font-size: 20px; margin: 0 auto;">Adicionar livro</h5>
              <button class="close" data-bs-dismiss="modal" aria-label="Close" style="position: absolute; right: 0; margin-right: 10px; margin-bottom: 5px; background-color: transparent; border: none; font-size: 35px;">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" style="text-align: center; background-color: rgb(206, 223, 229); font-size: 20px;">
                <div style="width: 100%; padding-left: 50px; padding-right: 50px;">
                    <b>
                        <br>Titulo:
                        <br><input type="text" id="txtLivro" style="width: 800px; margin-top: 10px; width: 100%; display: block; ">
                        <br><br>Descrição:
                        <br><input type="text" id="txtDescricao" style="width: 800px; margin-top: 10px; width: 100%; display: block;">
                        <br><br>URL da imagem:
                        <br><input type="text" id="txtUrl" style="width: 800px; margin-top: 10px; width: 100%; display: block;">
                    </b>
                    <br>
                </div>
            </div>
            <div class="modal-footer" style="background-color: rgb(206, 223, 229);">
              <button data-bs-dismiss="modal" style="background-color: red;  width: 120px; height: 30px; color: white; border-radius: 10px; border: none;">Cancelar</button>
              <button id="btnAdd" onclick="insertBook()" style="background-color: rgb(20, 190, 51);  width: 120px; height: 30px; color: white; border-radius: 10px; border: none;">Confirmar</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal" tabindex="-1" role="dialog" id="modalDel">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header" style="background-color: darkblue; color: white; padding: 7px;">
              <h5 class="modal-title" style="font-size: 20px; margin: 0 auto;">Confirmação</h5>
              <button class="close" data-bs-dismiss="modal" aria-label="Close" style="position: absolute; right: 0; margin-right: 10px; margin-bottom: 5px; background-color: transparent; border: none; font-size: 35px;">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" style="text-align: center; background-color: rgb(206, 223, 229); font-size: 20px;">
              <p>Deseja realmente excluir esse livro?</p>
            </div>
            <div class="modal-footer" style="background-color: rgb(206, 223, 229);">
                <button class="btn btn-secondary" data-bs-dismiss="modal" style="background-color: red;  width: 120px; height: 30px; color: white; border-radius: 10px; border: none; padding-top: 0; padding-bottom: 0;">Cancelar</button>
                <button class="btn btn-primary" id="btnDel" style="background-color: rgb(20, 190, 51);  width: 120px; height: 30px; color: white; border-radius: 10px; border: none; padding-top: 0; padding-bottom: 0;" onclick="delBook();">Confirmar</button>
              
            </div>
          </div>
        </div>
      </div>

      <script>
        var btnFav = document.getElementById("btnFav");
        btnFav.addEventListener("click", function(event){
            var color = btnFav.style.backgroundColor;
            if(color == "darkblue"){
                btnFav.style.backgroundColor = "purple";
            }
            else{
                btnFav.style.backgroundColor = "darkblue";
            }   
        })
      </script>

    <script>
        var btnAdd = document.getElementById("btnAdd");
        btnAdd.addEventListener("click", function(event){
            btnAdd.disabled = true; 
        })
    </script>

    <script>
        var btnDel = document.getElementById("btnDel");
        btnDel.addEventListener("click", function(event){
            btnDel.disabled = true; 
        })
    </script>

</body>
</html>